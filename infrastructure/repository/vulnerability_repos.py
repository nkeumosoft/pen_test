from typing import Dict, List
from uuid import UUID

from flask_sqlalchemy import SQLAlchemy

from infrastructure.framework.models import PenTestVulnerability
from pen_test.business.entity import VulnerabilityEntity
from pen_test.business.interfaces.ivulnerability import IVulnerability
from pen_test.business.interfaces.ivulnerability_repos import IVulnerabilityRepository


class VulnerabilityRepository(IVulnerabilityRepository):

    def __init__(self, db: SQLAlchemy, model: PenTestVulnerability):
        self._model = model
        self._db = db

    def find(self, uuid: UUID) -> VulnerabilityEntity:
        instance = self._model.query.get(uuid)
        return self._factory_vul_entity(instance)

    def find_by_name(self, name: str) -> VulnerabilityEntity:
        instance = self._model.query.filter_by(name=name).first()
        return self._factory_vul_entity(instance)

    def find_detail(self, uuid: UUID) -> Dict:
        instance = self._model.query.get(uuid)
        return self._factory_vul_entity(instance).attack_details

    def find_by_website(self, website: UUID) -> IVulnerability:
        instance = self._model.query_filter_by(website_id=website).first()
        return self._factory_vul_entity(instance)

    def list(self) -> List[VulnerabilityEntity]:
        instances = self._model.query.order_by(self._model.created_date).all()
        return [self._factory_vul_entity(instance) for instance in instances]

    def create(self, vul: VulnerabilityEntity) -> VulnerabilityEntity:
        instance = self._model.__int__(
            vul_id=vul.vul_id,
            website_id=vul.website_id,
            attack_name=vul.attack_name,
            num_vulnerability=vul.num_vulnerability,
            attack_details=vul.attack_details
        )
        self._db.session.add(instance)
        self._db.session.commit()

    @staticmethod
    def _factory_vul_entity(instance: PenTestVulnerability) -> VulnerabilityEntity:
        return VulnerabilityEntity.factory(
            uuid=instance.id,
            website_id=instance.website_id,
            attack_name=instance.attack_name,
            num_vulnerability=instance.num_vulnerability,
            attack_details=instance.attack_details
        )
